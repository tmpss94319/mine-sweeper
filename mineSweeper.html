<!DOCTYPE html>
<html lang="en">

<head>
    <title>踩地雷</title>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />

    <!-- Bootstrap CSS v5.2.1 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous" />
    <!-- font awesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
        integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

    <link rel="stylesheet" href="mineSweeper.css" />
</head>

<body>
    <div class="blocks-container"></div>

    <script>
        const blocksContainer = document.querySelector(".blocks-container");
        for (let i = 1; i <= 9; i++) {
            for (let j = 1; j <= 9; j++) {
                const div = document.createElement("div");
                div.className = `block unOpened block_${i}_${j}`;
                blocksContainer.appendChild(div);
            }
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
        integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
        crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"
        integrity="sha384-BBtl+eGJRgqQAUMxJ7pMwbEyER4l1g+O15P+16Ep7Q9Q+zqX6gSbd85u4mG4QzX+"
        crossorigin="anonymous"></script>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>

    <script>
        // ==============================命名變數======================================
        const blocks = document.querySelectorAll(".block"); //所有方塊
        const unOpenedBlocks = document.querySelectorAll(".unOpened"); //所有未打開的方塊
        const random_numbers = randomNumbers(10); // 生成10個隨機數字的陣列

        // =====================生成地雷
        let mineList = [];
        random_numbers.forEach((num) => {
            mineList.push(blocks[num - 1]); // 透過隨機生成的數字抓10個div元素到mineList裡
        });
        console.log('mineList:', mineList);

        // =====================將每個地雷的周圍八個DOM元素都加入surrBlocks陣列中
        let surrBlocks = [];
        mineList.forEach((mine) => {
            mine.classList.forEach((className) => {
                if (className.includes("block_")) {

                    const matched = className.match(/block_(\d+)_(\d+)/); // 用match函數配合樣板字串來抓地雷的座標
                    let mineRow = parseInt(matched[1]); // 第幾橫排
                    let mineCol = parseInt(matched[2]); // 第幾直排

                    const directions = [
                        [-1, -1],
                        [-1, 0],
                        [-1, 1],
                        [0, -1],
                        [0, 1],
                        [1, -1],
                        [1, 0],
                        [1, 1],
                    ];

                    directions.forEach((direction) => {
                        console.log('direction:', direction);
                        let newRow = mineRow + direction[0];
                        let newCol = mineCol + direction[1];
                        let newClassName = `block_${newRow}_${newCol}`;
                        console.log('newClassName:', newClassName);

                        const newBlock = document.querySelector(`.${newClassName}`); // 座標位移之後的方塊
                        console.log('newBlock:', newBlock);
                        if (newBlock) { surrBlocks.push(newBlock) } // 如果有找到該DOM元素，才加進方塊surrBlocks陣列中
                    });
                }
            });
        });
        console.log('surrBlocks:', surrBlocks);

        unOpenedBlocks.forEach((unOpened) => {
            unOpened.addEventListener("click", (e) => {
                openBlock(e.target);
            });
        });

        // =========== functions here ==============

        function randomNumbers(length) {
            let numbers = [];
            let i = 1;
            while (i <= length) {
                let spot = Math.floor(Math.random() * 100);
                if (!numbers.includes(spot) && spot >= 1 && spot <= 81) {
                    numbers.push(spot);
                    i++;
                }
            }
            return numbers;
        }

        function countRepeat(array, target) {
            let count = 0;
            array.forEach(element => {
                if (element === target) {
                    count += 1;
                }
            });
            return count;
        }
        
        // ========================開啟方塊的函數
        function openBlock(block) {
                // 如果是地雷
                if (mineList.includes(block)) { 
                    block.style.backgroundImage =
                        "url('./assets/images/bombRed.png')";
                    block.style.backgroundSize = "contain";
                }

                // 如果是數字
                if(surrBlocks.includes(block) && !mineList.includes(block)) { 
                    block.style.backgroundImage =
                        `url('./assets/images/${countRepeat(surrBlocks, block)}.png')`;
                    block.style.backgroundSize = "contain";
                }

                console.log('block.className:', block.className);
                block.classList.remove("unOpened");
                block.classList.add("opened");
        }

        function getSurrBlocks (surrArray, block) {
            block.classList.forEach((className) => {
                if (className.includes("block_")) {
                    const matched = className.match(/block_(\d+)_(\d+)/); // 用match函數配合樣板字串來抓座標
                    let blockRow = parseInt(matched[1]);
                    let blockCol = parseInt(matched[2]);

                    const directions = [
                        [-1, -1],
                        [-1, 0],
                        [-1, 1],
                        [0, -1],
                        [0, 1],
                        [1, -1],
                        [1, 0],
                        [1, 1],
                    ];

                    directions.forEach((direction) => {
                        console.log('direction', direction);
                        let newRow = blockRow + direction[0];
                        let newCol = blockCol + direction[1];
                        let newClassName = `block_${newRow}_${newCol}`;
                        const newBlock = document.querySelector(`.${newClassName}`);
                        if (newBlock) { surrBlocks.push(newBlock) }
                    });
                }
            });
        }
    </script>
</body>

</html>